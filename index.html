<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AI问答助手 - 无明文配置版</title>
    <style>
        /* 全局样式重置 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: system-ui, -apple-system, sans-serif;
        }

        body {
            background: #f0f2f5;
            min-height: 100vh;
            padding: 10px;
        }

        /* 主容器 */
        .chat-app {
            max-width: 800px;
            margin: 0 auto;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        /* 顶部标题栏 */
        .app-header {
            background: #1677ff;
            color: #fff;
            padding: 18px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-title {
            font-size: 18px;
            font-weight: 600;
        }

        .clear-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: #fff;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .clear-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* 聊天内容区 */
        .chat-content {
            height: 500px;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* 空聊天提示 */
        .empty-tip {
            text-align: center;
            color: #8c8c8c;
            font-size: 14px;
            padding: 40px 0;
        }

        /* 消息样式 */
        .message {
            max-width: 75%;
            padding: 10px 16px;
            border-radius: 18px;
            line-height: 1.4;
            position: relative;
            word-wrap: break-word;
        }

        .msg-user {
            align-self: flex-end;
            background: #1677ff;
            color: #fff;
        }

        .msg-ai {
            align-self: flex-start;
            background: #e5e6eb;
            color: #1d1d1f;
        }

        /* AI标识 */
        .msg-ai::before {
            content: 'AI';
            position: absolute;
            left: -22px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 11px;
            color: #8c8c8c;
        }

        /* 时间戳 */
        .msg-time {
            font-size: 9px;
            color: #8c8c8c;
            position: absolute;
            bottom: -16px;
            white-space: nowrap;
        }

        .msg-user .msg-time {
            right: 16px;
        }

        .msg-ai .msg-time {
            left: 16px;
        }

        /* 输入区 */
        .input-area {
            padding: 15px;
            border-top: 1px solid #e5e6eb;
            display: flex;
            gap: 8px;
        }

        #msg-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #e5e6eb;
            border-radius: 24px;
            outline: none;
            font-size: 14px;
            resize: none;
            height: 48px;
            max-height: 120px;
        }

        #send-btn {
            background: #1677ff;
            color: #fff;
            border: none;
            border-radius: 24px;
            padding: 0 20px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }

        #send-btn:hover {
            background: #0f62d9;
        }

        #send-btn:disabled {
            background: #8bb8ff;
            cursor: not-allowed;
        }

        /* 加载动画 */
        .loading {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 打字中动画 */
        .typing-box {
            align-self: flex-start;
            background: #e5e6eb;
            padding: 10px 16px;
            border-radius: 18px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .typing-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: #8c8c8c;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* 错误提示 */
        .error-tip {
            background: #fff2f2;
            color: #f53f3f;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 13px;
            text-align: center;
            margin: 0 15px;
        }
    </style>
</head>
<body>
    <div class="chat-app">
        <!-- 顶部标题栏 -->
        <div class="app-header">
            <div class="app-title">AI问答助手</div>
            <button class="clear-btn" onclick="clearChat()">清除记录</button>
        </div>

        <!-- 聊天内容区 -->
        <div class="chat-content" id="chat-content">
            <!-- 初始消息由JS生成 -->
        </div>

        <!-- 输入区 -->
        <div class="input-area">
            <textarea id="msg-input" placeholder="请输入你的问题..." oninput="resizeInput(this)"></textarea>
            <button id="send-btn" onclick="sendMsg()">发送</button>
        </div>
    </div>

    <script>
        // ==================== 1. 加密配置（已填入你的专属编码）====================
        const CONFIG_CODE = {
            // 你的URL编码（已替换）
            url: [109, 121, 121, 117, 120, 63, 52, 52, 125, 110, 102, 116, 102, 110, 51, 117, 113, 122, 120, 52, 123, 54, 52, 104, 109, 102, 121, 52, 104, 116, 114, 117, 113, 106, 121, 110, 116, 115, 120],
            // 你的Key编码（已替换）
            key: [120, 112, 50, 85, 82, 60, 106, 74, 112, 73, 120, 77, 111, 103, 115, 92, 113, 113, 71, 70, 107, 62, 61, 61, 61, 54, 54, 75, 61, 75, 59, 57, 105, 53, 103, 70, 58, 62, 106, 56, 59, 55, 60, 72, 103, 73, 105, 61, 102, 75, 61],
            // 解码密钥（与生成编码时一致）
            secret: 5
        };

        // ==================== 2. 解码工具函数（仅ASCII，无编码错误）====================
        /**
         * 数字编码转字符串
         * @param {Array} codeArr - 数字编码数组
         * @param {number} secret - 解码密钥
         * @returns {string} 解码后的字符串
         */
        function decodeCode(codeArr, secret) {
            return codeArr.map(num => {
                // 加减解密，确保字符在ASCII范围内
                const charCode = (num - secret + 128) % 128;
                return String.fromCharCode(charCode);
            }).join('');
        }

        /**
         * 获取API配置（运行时解码，不存储）
         * @returns {object} {url, key}
         */
        function getApiConfig() {
            try {
                const url = decodeCode(CONFIG_CODE.url, CONFIG_CODE.secret);
                const key = decodeCode(CONFIG_CODE.key, CONFIG_CODE.secret);
                
                // 基础验证
                if (!url.startsWith('https') || !key.startsWith('sk-')) {
                    throw new Error('配置无效');
                }
                return { url, key };
            } catch (e) {
                console.error('配置解码失败:', e);
                return { url: '', key: '' };
            }
        }

        // ==================== 3. 工具函数（界面/交互）====================
        /**
         * 获取格式化时间戳
         * @returns {string} HH:mm:ss
         */
        function getTime() {
            const now = new Date();
            return [
                String(now.getHours()).padStart(2, '0'),
                String(now.getMinutes()).padStart(2, '0'),
                String(now.getSeconds()).padStart(2, '0')
            ].join(':');
        }

        /**
         * 自适应输入框高度
         * @param {HTMLTextAreaElement} el - 输入框元素
         */
        function resizeInput(el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 120) + 'px';
        }

        /**
         * 添加消息到聊天区
         * @param {string} content - 消息内容
         * @param {boolean} isUser - 是否是用户消息
         * @returns {HTMLElement} 消息元素
         */
        function addMsg(content, isUser = false) {
            const chatContent = document.getElementById('chat-content');
            // 移除空提示
            chatContent.querySelector('.empty-tip')?.remove();

            // 创建消息元素
            const msgEl = document.createElement('div');
            msgEl.className = `message ${isUser ? 'msg-user' : 'msg-ai'}`;
            // 转义特殊字符
            const safeContent = content.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            msgEl.innerHTML = `
                ${safeContent}
                <div class="msg-time">${getTime()}</div>
            `;

            chatContent.appendChild(msgEl);
            // 滚动到底部
            chatContent.scrollTop = chatContent.scrollHeight;
            return msgEl;
        }

        /**
         * 显示打字中动画
         * @returns {HTMLElement} 打字中元素
         */
        function showTyping() {
            const chatContent = document.getElementById('chat-content');
            const typingEl = document.createElement('div');
            typingEl.className = 'typing-box';
            typingEl.innerHTML = `
                <span class="typing-dot"></span>
                <span class="typing-dot"></span>
                <span class="typing-dot"></span>
            `;
            chatContent.appendChild(typingEl);
            chatContent.scrollTop = chatContent.scrollHeight;
            return typingEl;
        }

        /**
         * 打字机效果显示文本
         * @param {HTMLElement} el - 消息元素
         * @param {string} text - 要显示的文本
         * @param {number} speed - 打字速度（毫秒/字符）
         */
        function typeWriter(el, text, speed = 15) {
            let i = 0;
            el.innerHTML = `<div class="msg-time">${getTime()}</div>`;
            const contentEl = document.createElement('span');
            el.insertBefore(contentEl, el.firstChild);

            function type() {
                if (i < text.length) {
                    contentEl.textContent += text.charAt(i);
                    i++;
                    document.getElementById('chat-content').scrollTop = document.getElementById('chat-content').scrollHeight;
                    setTimeout(type, speed);
                }
            }
            type();
        }

        /**
         * 显示错误提示
         * @param {string} msg - 错误信息
         */
        function showError(msg) {
            const chatContent = document.getElementById('chat-content');
            const errorEl = document.createElement('div');
            errorEl.className = 'error-tip';
            errorEl.textContent = msg;
            chatContent.appendChild(errorEl);
            chatContent.scrollTop = chatContent.scrollHeight;
            // 5秒后移除
            setTimeout(() => errorEl.remove(), 5000);
        }

        // ==================== 4. 核心业务逻辑 ====================
        // 聊天历史（保留3轮：6条消息）
        let chatHistory = [];

        /**
         * 清除聊天记录
         */
        function clearChat() {
            const chatContent = document.getElementById('chat-content');
            chatContent.innerHTML = '<div class="empty-tip">暂无聊天记录，开始提问吧！</div>';
            chatHistory = [];
        }

        /**
         * 发送消息
         */
        async function sendMsg() {
            const input = document.getElementById('msg-input');
            const sendBtn = document.getElementById('send-btn');
            const msg = input.value.trim();

            if (!msg) return;

            // 状态更新
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<div class="loading"></div>';
            // 添加用户消息
            addMsg(msg, true);
            // 加入历史
            chatHistory.push({ role: 'user', content: msg });
            // 清空输入框
            input.value = '';
            input.style.height = '48px';

            try {
                // 1. 获取API配置（运行时解码）
                const { url: apiUrl, key: apiKey } = getApiConfig();
                if (!apiUrl || !apiKey) {
                    throw new Error('API配置解码失败，请检查编码和密钥');
                }

                // 2. 显示打字中
                const typingEl = showTyping();

                // 3. 处理上下文：保留最近3轮（6条）
                const context = chatHistory.slice(-6);

                // 4. 发送请求（带超时）
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 15000);

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: context,
                        temperature: 0.7,
                        max_tokens: 1024
                    }),
                    signal: controller.signal,
                    mode: 'cors',
                    credentials: 'omit'
                });

                // 清除超时
                clearTimeout(timeout);
                // 移除打字中
                typingEl.remove();

                // 5. 处理响应
                if (!response.ok) {
                    const errText = await response.text().catch(() => '');
                    throw new Error(`请求失败 [${response.status}]：${errText.substring(0, 60)}`);
                }

                const data = await response.json();
                if (!data.choices || !data.choices[0]?.message?.content) {
                    throw new Error('API返回无有效内容');
                }

                // 6. 处理AI回复
                const aiReply = data.choices[0].message.content;
                chatHistory.push({ role: 'assistant', content: aiReply });
                const aiMsgEl = addMsg('', false);
                typeWriter(aiMsgEl, aiReply);

            } catch (error) {
                console.error('发送失败:', error);
                // 分类提示错误
                let errMsg = '';
                if (error.name === 'AbortError') {
                    errMsg = '请求超时（15秒），请检查网络或API服务';
                } else if (error.message.includes('Failed to fetch')) {
                    errMsg = '网络请求失败：跨域限制/API地址不可达';
                } else {
                    errMsg = `发送失败：${error.message}`;
                }
                showError(errMsg);
                // 移除残留的打字中
                document.querySelector('.typing-box')?.remove();
            } finally {
                // 恢复发送按钮
                sendBtn.disabled = false;
                sendBtn.textContent = '发送';
            }
        }

        // ==================== 5. 初始化与事件绑定 ====================
        /**
         * 页面初始化
         */
        function init() {
            // 添加初始消息
            const initMsg = addMsg('你好！我是AI助手，有什么可以帮助你的吗？', false);
            // 初始化历史
            chatHistory.push({ role: 'assistant', content: initMsg.textContent.trim() });

            // 回车发送（Shift+Enter换行）
            document.getElementById('msg-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMsg();
                }
            });
        }

        // 页面加载完成后初始化
        window.onload = init;
    </script>
</body>
</html>
